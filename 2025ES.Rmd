```{r}
# ---------------------------------------------------------------
# 描述性統計分析腳本 (R) - [2025-10-28 v4 更新版]
# - 更新 1: 數值型統計(numeric_stats) 將按 Q 編號排序
# - 更新 2: 修正類別型統計(categorical_stats)的 Value 欄位錯誤
# - 更新 3: 新增 Q31, Q32, Q33 的特殊編碼規則 (我不理解=0)
# - 更新 4 (本次): 新增 Q4 (年資) 的特殊數值編碼 (0.5, 1.5, 2.5, 3)
# ---------------------------------------------------------------

# --- 0. 安裝與載入套件 ---
# install.packages("tidyverse")
# install.packages("janitor")

library(tidyverse) # 用於資料處理 (dplyr, readr, tidyr, stringr)
library(janitor)   # 用於建立次數分配表 (tabyl)

# 設定檔案路徑 (請確保檔案與 R 腳本在同一目錄，或提供完整路徑)
file_path <- "2025 CZ Engagement survey (回覆) 的副本 - 表單回應 1.csv"

# --- 1. 載入資料 ---
tryCatch({
  df_raw <- read_csv(file_path)
  print(paste("成功載入檔案:", file_path))
  print(paste("資料維度:", dim(df_raw)[1], "筆觀察值,", dim(df_raw)[2], "個欄位"))
}, error = function(e) {
  stop(paste("無法讀取檔案，請檢查路徑是否正確:", file_path, "\n錯誤訊息:", e$message))
})


# --- 2. 建立 Codebook 並重命名欄位 ---
original_names <- colnames(df_raw)
new_names <- paste0("Q", 1:length(original_names))

codebook <- tibble(
  New_Column = new_names,
  Original_Column = original_names
)

df_renamed <- df_raw
colnames(df_renamed) <- new_names

print("已建立欄位對照表 (Codebook)，變數 'codebook' 可供查閱。")
write_csv(codebook, "codebook.csv")


# --- 3. 自動分類與清理欄位 ---
LIKERT_PATTERN <- "^\\s*\\d+\\s*-.+" 
MIN_AVG_LEN_FOR_QUALITATIVE <- 50  
MAX_UNIQUE_FOR_CATEGORICAL <- 15 

# --- [更新 5] ---
special_likert_cols <- c("Q31", "Q32", "Q33")
# 將 Q4 和 Q100 都加入特殊數值編碼清單
special_numeric_cols <- c("Q4", "Q100")

# 準備用來存放分類結果的向量
likert_text_cols <- c()       
custom_likert_cols <- c()     
custom_numeric_cols <- c()    # [更新] Q4 和 Q100 會進入這裡
qualitative_cols <- c()       
numeric_cols_pre <- c()       
categorical_cols_pre <- c()   

# 遍歷所有欄位進行分類
for (col in new_names) {
  if (all(is.na(df_renamed[[col]]))) next
  col_type <- class(df_renamed[[col]])
  
  if (col_type %in% c("numeric", "integer", "double")) {
    numeric_cols_pre <- c(numeric_cols_pre, col)
  } else if (col_type == "character") {
    first_val <- first(na.omit(df_renamed[[col]]))
    
    if (col %in% special_likert_cols) {
      custom_likert_cols <- c(custom_likert_cols, col)
    } else if (col %in% special_numeric_cols) {
      # Q4 和 Q100 會進入這裡
      custom_numeric_cols <- c(custom_numeric_cols, col)
    } else if (!is.na(first_val) && str_detect(first_val, LIKERT_PATTERN)) {
      likert_text_cols <- c(likert_text_cols, col)
    } else {
      avg_len <- mean(nchar(df_renamed[[col]]), na.rm = TRUE)
      n_unique <- n_distinct(df_renamed[[col]], na.rm = TRUE)
      if (avg_len > MIN_AVG_LEN_FOR_QUALITATIVE || n_unique > MAX_UNIQUE_FOR_CATEGORICAL) {
        qualitative_cols <- c(qualitative_cols, col)
      } else {
        categorical_cols_pre <- c(categorical_cols_pre, col)
      }
    }
  }
}
print("欄位分類完成 (已加入 Q4, Q31-Q33, Q100 特殊規則)。")

# --- 4. 執行資料清理 (轉換 Likert 欄位) ---

df_cleaned <- df_renamed %>%
  # (A) 處理標準 Likert 欄位 (抓開頭數字)
  mutate(across(all_of(likert_text_cols), 
                ~as.numeric(str_extract(.x, "^\\s*\\d+")))) %>%
  
  # (B) 處理 Q31-Q33 特殊編碼欄位
  mutate(across(all_of(custom_likert_cols),
                ~case_when(
                  str_detect(.x, "^4") ~ 4,
                  str_detect(.x, "^3") ~ 3,
                  str_detect(.x, "^2") ~ 2,
                  str_detect(.x, "^1") ~ 1,
                  str_detect(.x, "我不理解") ~ 0,
                  TRUE ~ NA_real_ 
                ))) %>%

  # (C) 處理 Q4 (年資) 特殊編碼
  # [優化] 直接針對欄位名稱 mutate，更清晰
  mutate(Q4 = case_when(
          Q4 == "1 年以下" ~ 0.5,
          Q4 == "1-2 年" ~ 1.5,
          Q4 == "2-3 年" ~ 2.5,
          Q4 == "3 年以上" ~ 3.0,
          TRUE ~ NA_real_ 
        )) %>%

  # --- [更新 5] (D) 處理 Q100 (留任) 特殊編碼 ---
  mutate(Q100 = case_when(
          Q100 == "不考慮持續任職" ~ 0,
          Q100 == "考慮 1 年內持續任職" ~ 0.5,
          Q100 == "考慮 1 - 2 年內持續任職" ~ 1.5,
          Q100 == "考慮任職 2 年以上" ~ 2.0,
          TRUE ~ NA_real_
        ))

print("Likert, Q4, Q100 欄位已轉換為數值。")

# --- 5. 執行描述性統計 (數值型/評分型欄位) ---

# --- [更新 4] 最終的數值欄位 = 原始數值 + 標準 Likert + 自訂 Likert + Q4 ---
numeric_analysis_cols <- c(numeric_cols_pre, likert_text_cols, custom_likert_cols, custom_numeric_cols)
numeric_analysis_cols <- setdiff(numeric_analysis_cols, "Q1") # 排除 Q1 (時間戳記)

# 計算描述性統計
numeric_stats <- df_cleaned %>%
  select(all_of(numeric_analysis_cols)) %>%
  summarise(
    across(
      everything(),
      list(
        N = ~sum(!is.na(.)),
        Mean = ~mean(.x, na.rm = TRUE),
        SD = ~sd(.x, na.rm = TRUE),
        Median = ~median(.x, na.rm = TRUE),
        Min = ~min(.x, na.rm = TRUE),
        Max = ~max(.x, na.rm = TRUE)
      ),
      .names = "{.col}___{.fn}" 
    )
  ) %>%
  pivot_longer(
    cols = everything(),
    names_to = "Metric",
    values_to = "Value"
  ) %>%
  separate(Metric, into = c("New_Column", "Statistic"), sep = "___") %>%
  pivot_wider(
    names_from = Statistic,
    values_from = Value
  ) %>%
  left_join(codebook, by = "New_Column") %>%
  select(New_Column, Original_Column, N, Mean, SD, Median, Min, Max) %>%
  mutate(
    Mean = ifelse(is.nan(Mean), NA, Mean),
    SD = ifelse(is.nan(SD), NA, SD)
  ) %>%
  # 排序 (按 Q 編號)
  mutate(sort_key = as.numeric(str_replace(New_Column, "Q", ""))) %>%
  arrange(sort_key) %>%
  select(-sort_key)

print("--- 數值型欄位描述性統計 (Numeric/Likert Stats) [已按 Q 編號排序, 含 Q4, Q31-Q33] ---")
print(numeric_stats, n = Inf) 

print("數值型統計已儲存至變數 'numeric_stats'")
write_csv(numeric_stats, "numeric_descriptive_stats.csv")


# --- 6. 執行描述性統計 (類別型欄位) ---

# [更新 4] Q4 已被移除，這裡不需更動
categorical_analysis_cols <- categorical_cols_pre

categorical_stats <- map_dfr(categorical_analysis_cols, ~{
  df_cleaned %>%
    tabyl(.data[[.x]]) %>%
    mutate(New_Column = .x) %>%
    rename(Value = 1) # [修正]
}, .id = NULL) %>%
  rename(Frequency = n, Percentage = percent) %>%
  left_join(codebook, by = "New_Column") %>%
  select(New_Column, Original_Column, Value, Frequency, Percentage) %>%
  arrange(New_Column, desc(Frequency))%>%
  mutate(sort_key = as.numeric(str_replace(New_Column, "Q", ""))) %>%
  arrange(sort_key) %>%
  select(-sort_key)

print("--- 類別型欄位次數分配 (Categorical Stats) ---")
print(categorical_stats, n = Inf)

print("類別型統計已儲存至變數 'categorical_stats'")
write_csv(categorical_stats, "categorical_descriptive_stats.csv")

print("--- 分析完成 ---")
```
```{r}
# --- 5. 執行「分群」描述性統計 ---

# (A) 定義要分析的數值欄位
numeric_analysis_cols <- c(numeric_cols_pre, likert_text_cols, custom_likert_cols, custom_numeric_cols)
numeric_analysis_cols <- setdiff(numeric_analysis_cols, "Q1") # 排除 Q1 (時間戳記)

# (B) 定義您要納入分析的組別
# Q2 = 我的組別
target_groups <- c("領導發展", "營運發展", "教學發展", "影響力發展", "聯盟發展")

# (C) 執行分群計算
grouped_numeric_stats <- df_cleaned %>%
  # (C.1) 篩選出您指定的組別
  filter(Q2 %in% target_groups) %>%
  
  # (C.2) 依據 Q2 (組別) 進行分組
  group_by(Q2) %>%
  
  # (C.3) 對所有數值欄位進行彙總
  summarise(
    across(
      all_of(numeric_analysis_cols),
      list(
        N = ~sum(!is.na(.)),
        Mean = ~mean(.x, na.rm = TRUE),
        SD = ~sd(.x, na.rm = TRUE),
        Median = ~median(.x, na.rm = TRUE),
        Min = ~min(.x, na.rm = TRUE),
        Max = ~max(.x, na.rm = TRUE)
      ),
      .names = "{.col}___{.fn}"
    ),
    .groups = "drop" # 計算完畢後解除分組
  ) %>%
  
  # (C.4) 轉換為長表格 (方便閱讀與後續處理)
  pivot_longer(
    cols = -Q2, # 排除 Q2 (組別) 欄
    names_to = "Metric",
    values_to = "Value"
  ) %>%
  separate(Metric, into = c("New_Column", "Statistic"), sep = "___") %>%
  
  # (C.5) 轉回寬表格 (N, Mean, SD... 變回欄位)
  pivot_wider(
    names_from = Statistic,
    values_from = Value
  ) %>%
  
  # (C.6) 整理結果
  left_join(codebook, by = "New_Column") %>%
  mutate(
    Mean = ifelse(is.nan(Mean), NA, Mean),
    SD = ifelse(is.nan(SD), NA, SD)
  ) %>%
  
  # (C.7) 排序：先按組別，再按 Q 編號
  mutate(sort_key = as.numeric(str_replace(New_Column, "Q", ""))) %>%
  arrange(Q2, sort_key) %>%
  
  # (C.8) 最終欄位排序
  select(Q2, New_Column, Original_Column, N, Mean, SD, Median, Min, Max, -sort_key)

print("--- 依組別 (Q2) 分群之描述性統計 ---")
print(grouped_numeric_stats, n = Inf)

# 提示：儲存這個分群結果
print("分群統計已儲存至變數 'grouped_numeric_stats'")
write_csv(grouped_numeric_stats, "grouped_numeric_stats.csv")

print("--- 分群分析完成 ---")
```
```{r}

```
```{r}
# ---------------------------------------------------------------
# 分群描述性統計 (R) - 依「總工作年資」(Q4) [v6 更新版]
# - 更新 (本次): 納入 Q100 (留任) 的特殊數值編碼
# ---------------------------------------------------------------

# --- 0. 載入套件 ---
library(tidyverse)
library(stringr)

# --- 1. 載入資料 ---
file_path <- "2025 CZ Engagement survey (回覆) 的副本 - 表單回應 1.csv"
tryCatch({
  df_raw <- read_csv(file_path)
  print(paste("成功載入檔案:", file_path))
}, error = function(e) {
  stop(paste("無法讀取檔案:", e$message))
})

# --- 2. 建立 Codebook 並重命名欄位 ---
original_names <- colnames(df_raw)
new_names <- paste0("Q", 1:length(original_names))
codebook <- tibble(
  New_Column = new_names,
  Original_Column = original_names
)
df_renamed <- df_raw
colnames(df_renamed) <- new_names

# --- 3. 欄位分類 (與主腳本 v5 相同) ---
LIKERT_PATTERN <- "^\\s*\\d+\\s*-.+" 
special_likert_cols <- c("Q31", "Q32", "Q33")
special_numeric_cols <- c("Q4", "Q100") # [更新] 納入 Q100

likert_text_cols <- c()
custom_likert_cols <- c()
custom_numeric_cols <- c() # [更新] 納入 Q100
numeric_cols_pre <- c()

for (col in new_names) {
  if (all(is.na(df_renamed[[col]]))) next
  col_type <- class(df_renamed[[col]])
  
  if (col_type %in% c("numeric", "integer", "double")) {
    numeric_cols_pre <- c(numeric_cols_pre, col)
  } else if (col_type == "character") {
    first_val <- first(na.omit(df_renamed[[col]]))
    
    if (col %in% special_likert_cols) {
      custom_likert_cols <- c(custom_likert_cols, col)
    } else if (col %in% special_numeric_cols) {
      custom_numeric_cols <- c(custom_numeric_cols, col) # [更新] 納入 Q100
    } else if (!is.na(first_val) && str_detect(first_val, LIKERT_PATTERN)) {
      likert_text_cols <- c(likert_text_cols, col)
    }
  }
}
print("欄位分類完成 (已納入 Q100)。")

# --- 4. 執行資料清理 (與主腳本 v5 相同) ---
df_cleaned <- df_renamed %>%
  mutate(across(all_of(likert_text_cols), 
                ~as.numeric(str_extract(.x, "^\\s*\\d+")))) %>%
  mutate(across(all_of(custom_likert_cols),
                ~case_when(
                  str_detect(.x, "^4") ~ 4,
                  str_detect(.x, "^3") ~ 3,
                  str_detect(.x, "^2") ~ 2,
                  str_detect(.x, "^1") ~ 1,
                  str_detect(.x, "我不理解") ~ 0,
                  TRUE ~ NA_real_
                ))) %>%
  # (C) 處理 Q4 (年資)
  mutate(Q4 = case_when(
          Q4 == "1 年以下" ~ 0.5,
          Q4 == "1-2 年" ~ 1.5,
          Q4 == "2-3 年" ~ 2.5,
          Q4 == "3 年以上" ~ 3.0,
          TRUE ~ NA_real_ 
        )) %>%
  # (D) [更新] 處理 Q100 (留任)
  mutate(Q100 = case_when(
          Q100 == "不考慮持續任職" ~ 0,
          Q100 == "考慮 1 年內持續任職" ~ 0.5,
          Q100 == "考慮 1 - 2 年內持續任職" ~ 1.5,
          Q100 == "考慮任職 2 年以上" ~ 2.0,
          TRUE ~ NA_real_
        ))
print("資料清理完成 (已納入 Q100)。")


# --- 5. 執行「分群」描述性統計 (依 Q4 年資) ---

# (A) 定義要分析的數值欄位
# [更新] 納入 custom_numeric_cols
numeric_analysis_cols <- c(numeric_cols_pre, likert_text_cols, custom_likert_cols, custom_numeric_cols)
numeric_analysis_cols <- setdiff(numeric_analysis_cols, "Q1") 

# (B) 定義您要的年資「文字」組別
target_seniority_groups <- c("1 年以下", "1-2 年", "2-3 年", "3 年以上")

# (C) 執行分群計算
grouped_numeric_stats_by_seniority <- df_cleaned %>%
  
  # (C.1) 建立新的「文字」分組欄位 Q4_grouped
  mutate(Q4_grouped = case_when(
    Q4 == 0.5 ~ "1 年以下",
    Q4 == 1.5 ~ "1-2 年",
    Q4 == 2.5 ~ "2-3 年",
    Q4 == 3.0 ~ "3 年以上",
    TRUE ~ NA_character_ 
  )) %>%
  
  # (C.2) 篩選出您指定的組別
  filter(Q4_grouped %in% target_seniority_groups) %>%
  
  # (C.3) 依據 *新的* Q4_grouped (年資) 進行分組
  group_by(Q4_grouped) %>%
  
  # (C.4) 執行 across() 時，排除 Q4 
  # Q100 會被自動計算
  summarise(
    across(
      all_of(setdiff(numeric_analysis_cols, "Q4")), # 排除 Q4
      list(
        N = ~sum(!is.na(.)),
        Mean = ~mean(.x, na.rm = TRUE),
        SD = ~sd(.x, na.rm = TRUE),
        Median = ~median(.x, na.rm = TRUE),
        Min = ~min(.x, na.rm = TRUE),
        Max = ~max(.x, na.rm = TRUE)
      ),
      .names = "{.col}___{.fn}"
    ),
    .groups = "drop" 
  ) %>%
  
  # (C.5) 轉換為長表格
  pivot_longer(
    cols = -Q4_grouped, 
    names_to = "Metric",
    values_to = "Value"
  ) %>%
  separate(Metric, into = c("New_Column", "Statistic"), sep = "___") %>%
  
  # (C.6) 轉回寬表格
  pivot_wider(
    names_from = Statistic,
    values_from = Value
  ) %>%
  
  # (C.7) 整理結果
  left_join(codebook, by = "New_Column") %>%
  mutate(
    Mean = ifelse(is.nan(Mean), NA, Mean),
    SD = ifelse(is.nan(SD), NA, SD)
  ) %>%
  
  # (C.8) 排序：先按年資，再按 Q 編號
  mutate(Q4_grouped = factor(Q4_grouped, levels = target_seniority_groups)) %>% 
  mutate(sort_key = as.numeric(str_replace(New_Column, "Q", ""))) %>%
  arrange(Q4_grouped, sort_key) %>%
  
  # (C.9) 最終欄位排序
  select(Q4_grouped, New_Column, Original_Column, N, Mean, SD, Median, Min, Max, -sort_key)

print("--- 依總工作年資 (Q4_grouped) 分群之描述性統計 ---")
print(grouped_numeric_stats_by_seniority, n = Inf)

# 提示：儲存這個分群結果
print("分群統計已儲存至變數 'grouped_numeric_stats_by_seniority'")
write_csv(grouped_numeric_stats_by_seniority, "grouped_numeric_stats_by_Q4.csv")

print("--- 分群分析完成 ---")
```

